# Task: Battlescape Integration - Mission Data Transfer & Outcome Feedback

**Status:** TODO
**Priority:** Critical
**Created:** October 24, 2025
**Completed:** N/A
**Assigned To:** AI Agent

---

## Overview

Connect the campaign orchestrator (TASK-025) to the tactical battlescape layer, creating a seamless gameplay loop where:
1. Campaign generates missions with specific parameters (difficulty, enemy composition, objectives)
2. Mission data flows to battlescape for execution
3. Battlescape processes combat and calculates outcomes
4. Outcome data flows back to campaign for impact processing
5. Campaign progresses based on mission results

This is the **critical link** between strategic and tactical gameplay.

---

## Purpose

Without this integration, the campaign system cannot be played end-to-end. Players need to:
- Launch missions generated by the campaign
- Fight battles in the battlescape with mission-specific parameters
- See outcomes reflected in the campaign world (alien threat, resources, base state)

This task completes the core gameplay loop and makes TASK-025 playable.

---

## Requirements

### Functional Requirements
- [ ] Mission data structure flows from campaign to battlescape
- [ ] Campaign parameters affect battlescape difficulty/enemies
- [ ] Mission briefing screen displays mission objectives & threat level
- [ ] Battlescape processes combat with mission-specific rules
- [ ] Mission outcomes (victory/defeat) calculate impact scores
- [ ] Alien threat escalates based on player win/loss ratio
- [ ] Research & manufacturing affected by alien research progression
- [ ] Campaign state persists across mission transitions

### Technical Requirements
- [ ] Create `MissionTransitionHandler` for data flow
- [ ] Add mission context to Battlescape state
- [ ] Implement outcome calculation system
- [ ] Add difficulty scaling based on campaign threat
- [ ] Create bidirectional state sync between systems
- [ ] No state loss during transitions

### Acceptance Criteria
- [ ] Campaign generates mission → Mission launches in battlescape (0 errors)
- [ ] Player completes battle → Results reflect in campaign (threat updates, resources)
- [ ] Multiple missions can be played sequentially without state corruption
- [ ] Test with 5 consecutive missions: victory, victory, defeat, victory, defeat
- [ ] All state persists correctly across transitions

---

## Plan

### Step 1: Mission Data Structure & Flow (8 hours)
**Description:** Create the mission context that flows from campaign to battlescape
**Files to modify/create:**
- `engine/geoscape/mission_context.lua` (NEW - 300 lines)
- `engine/geoscape/campaign_orchestrator.lua` (modify - add mission launch)
- `engine/battlescape/mission_handler.lua` (NEW - 350 lines)
- `engine/gui/scenes/mission_briefing_screen.lua` (modify/create - 250 lines)

**What gets transferred:**
```lua
-- Mission Context Structure
{
  id = "mission_001",
  type = "alien_base",           -- site, ufo, base
  location = {x=45, y=23},       -- province coordinates
  objectives = {...},            -- primary/secondary objectives
  enemies = {...},               -- enemy composition & placement
  threat_level = 3,              -- 1-5 scale
  difficulty = 0.8,              -- 0.5-2.0 multiplier
  time_limit = 20,               -- turns before failure
  rewards = {money=5000, items={...}},
  campaign_day = 156,            -- for AI scaling
}
```

**Estimated time:** 8 hours

### Step 2: Mission Briefing Screen (6 hours)
**Description:** Display mission info before battle starts
**Files to modify/create:**
- `engine/gui/scenes/mission_briefing_screen.lua` (NEW - 350 lines)
- `engine/gui/widgets/mission_objectives_panel.lua` (NEW - 150 lines)
- `engine/gui/widgets/threat_assessment_panel.lua` (NEW - 120 lines)

**Features:**
- Mission name & objective display
- Enemy threat assessment (unit types, count, AI behavior)
- Rewards preview
- Mission map preview (biome/terrain type)
- Accept/Decline buttons with hotkeys
- Difficulty indicator visual

**Estimated time:** 6 hours

### Step 3: Difficulty Scaling System (7 hours)
**Description:** Adjust battlescape difficulty based on campaign threat
**Files to modify/create:**
- `engine/battlescape/difficulty_scaler.lua` (NEW - 280 lines)
- `engine/geoscape/threat_manager.lua` (modify - add difficulty calc)

**Scaling mechanics:**
```lua
-- Difficulty affects:
enemy_health *= (0.5 + threat_level * 0.3)        -- 0.5x to 1.4x
enemy_accuracy *= (0.5 + threat_level * 0.25)    -- Similar scaling
enemy_count *= (0.75 + threat_level * 0.15)      -- 0.75x to 1.25x
player_resource_availability *= (1.0 - threat_level * 0.1) -- Scarcity
ai_behavior = threat_level > 2 ? "aggressive" : "tactical"
```

**Estimated time:** 7 hours

### Step 4: Outcome Calculation System (9 hours)
**Description:** Process battle results and calculate impact
**Files to modify/create:**
- `engine/battlescape/outcome_calculator.lua` (NEW - 400 lines)
- `engine/geoscape/outcome_processor.lua` (NEW - 350 lines)
- `engine/battlescape/mission_end_screen.lua` (modify - 200 lines)

**Outcome affects:**
```lua
-- Victory:
threat_level -= 0.1              -- Alien progress slows
player_morale += 5
resources += mission_rewards
research_progress += 2%
salvage = all_enemy_equipment

-- Defeat:
threat_level += 0.3              -- Aliens emboldened
player_morale -= 15
units_lost = units_outside_LZ
base_threatened = true           -- Triggers base defense
alien_research += 5%
```

**Estimated time:** 9 hours

### Step 5: State Synchronization (6 hours)
**Description:** Ensure campaign state persists across transitions
**Files to modify/create:**
- `engine/core/state_manager.lua` (modify - add transition handling)
- `engine/geoscape/campaign_state_backup.lua` (NEW - 150 lines)

**Mechanisms:**
- Save campaign state before battlescape launch
- Restore campaign state on battlescape exit
- Handle both victory and defeat states
- Preserve turn counter & calendar
- Maintain unit status & inventory

**Estimated time:** 6 hours

### Step 6: Integration Testing (8 hours)
**Description:** Comprehensive test of mission flow
**Files to create:**
- `tests/integration/test_mission_flow.lua` (NEW - 500 lines)
- `tests/integration/test_campaign_battlescape_sync.lua` (NEW - 400 lines)

**Test scenarios:**
1. Mission generation → Briefing screen → Battlescape launch (0 errors)
2. Victory: Results update campaign (threat down, resources up)
3. Defeat: Results update campaign (threat up, units lost)
4. Multiple sequential missions (5 consecutive: V-V-D-V-D)
5. State persistence across 10 mission cycles
6. Edge cases: All units killed, Time limit hit, Base destroyed

**Estimated time:** 8 hours

---

## Implementation Details

### Architecture

**Mission Flow Diagram:**
```
Campaign Orchestrator
    ↓ (mission data)
Mission Context
    ↓
Mission Briefing Screen (player confirms)
    ↓ (accept)
Battlescape Entry (difficulty applied)
    ↓ (play battle)
Battlescape Combat
    ↓ (mission complete/defeat)
Outcome Calculator
    ↓ (impact scores)
Campaign Processor
    ↓ (apply effects)
Campaign State Updated
    ↓ (next turn)
Back to Campaign Loop
```

**Key Integration Points:**

1. **Campaign → Battlescape:**
   - CampaignOrchestrator calls `MissionContext.create(mission_data)`
   - Mission context passed to Battlescape via state manager
   - DifficultyScaler modifies enemy parameters

2. **Battlescape → Campaign:**
   - Battlescape calls `OutcomeCalculator.process(battle_result)`
   - Outcome flows to `CampaignProcessor.apply_outcome()`
   - Campaign state updated with effects

3. **State Management:**
   - Backup campaign state before transition
   - Restore on abort/defeat
   - Merge victory results into persistent state

### Key Components

- **MissionContext:** Data structure holding all mission parameters
- **MissionBriefingScreen:** UI for pre-mission confirmation
- **DifficultyScaler:** Converts threat level to battlescape parameters
- **OutcomeCalculator:** Processes battle results into impact scores
- **CampaignProcessor:** Applies outcome effects to campaign
- **StateManager:** Handles transition and persistence

### Dependencies

- TASK-025 (Campaign Orchestrator) - COMPLETE ✅
- Battlescape module (existing - verified functional)
- State Manager (existing - verified functional)
- Campaign Threat Manager (existing - verified functional)

---

## Testing Strategy

### Unit Tests
- Test MissionContext creation & validation
- Test DifficultyScaler calculations
- Test OutcomeCalculator impact scoring
- Test state backup/restore mechanism

### Integration Tests
- Full mission flow from campaign launch to completion
- Multiple sequential missions
- State persistence across 10 mission cycles
- Edge cases (all units lost, time limit, base defense)

### Manual Testing Steps

1. **Launch campaign with test settings:**
   ```lua
   -- In campaign_orchestrator.lua
   local test_mission = CampaignOrchestrator.generateTestMission()
   MissionContext.launch(test_mission)
   ```

2. **Verify mission briefing displays correctly:**
   - Mission name visible
   - Objectives listed
   - Threat level shown
   - Accept/Decline buttons functional

3. **Play battle to completion:**
   - Win with various objectives (primary/secondary)
   - Lose with different casualty levels
   - Hit time limit
   - All units eliminated

4. **Verify outcome processing:**
   - Check campaign threat increased/decreased appropriately
   - Verify resources updated
   - Check unit morale changes
   - Confirm alien research progressed

5. **Test multiple missions:**
   - Play 5 consecutive missions
   - Verify state doesn't corrupt
   - Check cumulative threat escalation
   - Confirm persistent updates

### Expected Results

After victory:
- Campaign threat -0.1
- Player morale +5
- Resources added
- Research progress +2%
- Mission marked complete in campaign log

After defeat:
- Campaign threat +0.3
- Player morale -15
- Lost units removed from roster
- Base alert triggered
- Mission marked failed in campaign log

---

## How to Run/Debug

### Running the Game
```bash
lovec "engine"
```

### Debugging Mission Flow

1. **Add debug output in campaign_orchestrator.lua:**
```lua
print("[Campaign] Launching mission: " .. mission.name)
print("[Campaign] Difficulty multiplier: " .. difficulty_multiplier)
```

2. **Check mission briefing shows:**
```lua
print("[Briefing] Mission context received")
print("[Briefing] Objectives: " .. table.concat(objectives, ", "))
```

3. **Verify battlescape receives data:**
```lua
print("[Battlescape] Mission loaded: " .. mission_context.id)
print("[Battlescape] Threat level: " .. mission_context.threat_level)
```

4. **Check outcome processing:**
```lua
print("[Outcome] Battle result: " .. (victory and "VICTORY" or "DEFEAT"))
print("[Outcome] Threat adjustment: " .. threat_change)
```

### Temporary Files
All temp debug files in: `love.filesystem.getSaveDirectory()` or `os.getenv("TEMP")`

---

## Documentation Updates

### Files to Update
- [ ] `api/CAMPAIGN.md` - Add mission context structure
- [ ] `api/BATTLESCAPE.md` - Document mission parameters
- [ ] `architecture/integration-flow.md` - Add flow diagram
- [ ] `docs/gameplay-loop.md` - Document complete gameplay flow (NEW)
- [ ] Code comments - Add mission flow documentation

---

## Notes

- Mission briefing is critical UX moment - must be polished
- Difficulty scaling must feel fair to player
- Outcome effects must be visible in campaign (not hidden)
- State transitions must be bulletproof (test extensively)
- Consider adding "Mission Results" screen between battlescape and campaign

---

## Blockers

None identified - all dependencies complete.

---

## Review Checklist

- [ ] Code follows Lua/Love2D best practices
- [ ] No global variables (all use `local`)
- [ ] Proper error handling with `pcall` where needed
- [ ] All temporary files use TEMP folder
- [ ] Console debugging statements added
- [ ] Tests written and passing
- [ ] Documentation updated
- [ ] Mission flow tested end-to-end (no crashes)
- [ ] State persistence verified
- [ ] Difficulty scaling feels balanced

---

## Estimated Total Time

**8 + 6 + 7 + 9 + 6 + 8 = 44 hours (5-6 days)**
